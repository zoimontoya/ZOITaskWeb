


<app-newTask *ngIf="isAddingTask" [loggedUser]="loggedUser" (cancel)="onCancelAddTask()" (add)="onAddTask($event)"></app-newTask>
<app-newTask *ngIf="editingTask" [task]="editingTask" [loggedUser]="loggedUser" (cancel)="onCancelEditTask()" (add)="onEditTask($event)"></app-newTask>

<!-- Modal para Tarea Urgente -->
<div *ngIf="showUrgentTaskModal" class="modal-overlay" (click)="onUrgentTaskModalOverlayClick($event)">
    <div class="modal-confirm urgent-task-modal" (click)="$event.stopPropagation()">
        <h3>⚡ Registrar Tarea Urgente</h3>
        <p class="urgent-task-description">
            Registra una tarea que has realizado y que no estaba planificada previamente.
        </p>
        
        <form (ngSubmit)="onSubmitUrgentTask()" class="urgent-task-form">
            <!-- Selector de Invernadero -->
            <div class="form-group">
                <label class="form-label">Invernadero *</label>
                <div class="urgent-selector-container">
                    <!-- Dropdown de invernaderos -->
                    <div class="urgent-dropdown" [class.open]="isUrgentInvernaderoOpen">
                        <div class="urgent-dropdown-header" (click)="toggleUrgentInvernadero()">
                            <span class="dropdown-text">
                                <span *ngIf="!urgentTask.invernadero">Seleccionar invernadero...</span>
                                <span *ngIf="urgentTask.invernadero">{{ urgentTask.invernadero }}</span>
                            </span>
                            <span class="dropdown-icon" [class.expanded]="isUrgentInvernaderoOpen">▼</span>
                        </div>
                        
                        <div class="urgent-dropdown-content" *ngIf="isUrgentInvernaderoOpen">
                            <div class="urgent-search-container">
                                <input 
                                    type="text" 
                                    class="urgent-search-input"
                                    [(ngModel)]="urgentInvernaderoSearch"
                                    name="urgentInvernaderoSearch"
                                    placeholder="Buscar invernadero..."
                                    (input)="filterUrgentInvernaderos()">
                            </div>
                            <div class="urgent-options-list">
                                <div 
                                    *ngFor="let inv of filteredUrgentInvernaderos" 
                                    class="urgent-option"
                                    (click)="selectUrgentInvernadero(inv)"
                                    [class.selected]="urgentTask.invernadero === inv">
                                    {{ inv }}
                                </div>
                                <div *ngIf="filteredUrgentInvernaderos.length === 0" class="urgent-no-results">
                                    No se encontraron invernaderos
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Selector de Tipo de Tarea -->
            <div class="form-group">
                <label class="form-label">Tipo de tarea *</label>
                <div class="urgent-selector-container">
                    <!-- Dropdown de tipos de tarea -->
                    <div class="urgent-dropdown" [class.open]="isUrgentTipoOpen">
                        <div class="urgent-dropdown-header" (click)="toggleUrgentTipo()">
                            <span class="dropdown-text">
                                <span *ngIf="!urgentTask.tipo_tarea">Seleccionar tipo de tarea...</span>
                                <span *ngIf="urgentTask.tipo_tarea">{{ urgentTask.tipo_tarea }}</span>
                            </span>
                            <span class="dropdown-icon" [class.expanded]="isUrgentTipoOpen">▼</span>
                        </div>
                        
                        <div class="urgent-dropdown-content" *ngIf="isUrgentTipoOpen">
                            <div class="urgent-search-container">
                                <input 
                                    type="text" 
                                    class="urgent-search-input"
                                    [(ngModel)]="urgentTipoSearch"
                                    name="urgentTipoSearch"
                                    placeholder="Buscar tipo de tarea..."
                                    (input)="filterUrgentTipos()">
                            </div>
                            <div class="urgent-options-list">
                                <ng-container *ngFor="let grupo of filteredUrgentTiposJerarquicos">
                                    <!-- Tipo principal (cabecera no seleccionable) -->
                                    <div class="urgent-tipo-header" *ngIf="grupo.hasSubtipos">
                                        {{ grupo.tipo }}
                                    </div>
                                    
                                    <!-- Subtipos seleccionables -->
                                    <div 
                                        *ngFor="let subtipo of grupo.subtipos"
                                        class="urgent-option urgent-subtipo"
                                        (click)="selectUrgentTipo(grupo.tipo + ' - ' + subtipo)"
                                        [class.selected]="urgentTask.tipo_tarea === (grupo.tipo + ' - ' + subtipo)">
                                        {{ subtipo }}
                                    </div>
                                    
                                    <!-- Tipo sin subtipos (seleccionable directamente) -->
                                    <div 
                                        *ngIf="!grupo.hasSubtipos"
                                        class="urgent-option"
                                        (click)="selectUrgentTipo(grupo.tipo)"
                                        [class.selected]="urgentTask.tipo_tarea === grupo.tipo">
                                        {{ grupo.tipo }}
                                    </div>
                                </ng-container>
                                
                                <div *ngIf="filteredUrgentTiposJerarquicos.length === 0" class="urgent-no-results">
                                    No se encontraron tipos de tarea
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Horas trabajadas -->
            <div class="form-group">
                <label class="form-label" for="urgentHoras">Horas trabajadas *</label>
            <input 
                type="number" 
                id="urgentHoras"
                [(ngModel)]="urgentTask.horas_trabajadas"
                name="urgentHoras"
                placeholder="Ej: 4"
                min="0.5"
                step="0.5"
                required>
        </div>
        
            <!-- Descripción -->
            <div class="form-group">
                <label class="form-label" for="urgentDescripcion">Descripción de la tarea *</label>
            <textarea 
                id="urgentDescripcion"
                [(ngModel)]="urgentTask.descripcion"
                name="urgentDescripcion"
                rows="3"
                placeholder="Describe qué se hizo y por qué fue necesario..."
                required></textarea>
        </div>
        
            <!-- Trabajadores asignados -->
            <div class="form-group">
                <label class="form-label">Trabajadores que participaron</label>
                <p class="field-note">Haz clic en "Asignar Trabajadores" para registrar quién trabajó en esta tarea</p>
                <button 
                    type="button" 
                    class="task-action-btn" 
                    (click)="onOpenWorkersForUrgentTask()">
                    <span class="icon">👥</span> Asignar Trabajadores
                </button>
            <div *ngIf="urgentTaskWorkers.length > 0" class="workers-summary">
                <small>{{ urgentTaskWorkers.length }} trabajador(es) asignado(s)</small>
            </div>
        </div>
        
            <div class="modal-actions">
                <button type="button" class="task-action-btn cancel-btn" (click)="onCancelUrgentTask()">
                    <span class="icon">❌</span> Cancelar
                </button>
                <button type="submit" class="task-action-btn validate-btn" [disabled]="!urgentTask.invernadero || !urgentTask.tipo_tarea || !urgentTask.descripcion || urgentTask.horas_trabajadas <= 0 || urgentTaskWorkers.length === 0">
                    <span class="icon">⚡</span> Registrar Tarea
                </button>
            </div>
        </form>
    </div>
</div>

<div *ngIf="showDeleteModal" class="modal-overlay" (click)="onDeleteModalOverlayClick($event)">
    <div class="modal-confirm" (click)="$event.stopPropagation()">
        <h3>¿Seguro que quieres eliminar esta tarea?</h3>
        <p *ngIf="taskToDelete">
            <b>{{taskToDelete.tipo_tarea}}</b> de invernadero <b>{{taskToDelete.invernadero}}</b>
        </p>
        <div class="modal-actions">
            <button class="task-action-btn delete-btn" (click)="confirmDeleteTask()">Sí, eliminar</button>
            <button class="task-action-btn" (click)="cancelDeleteTask()">Cancelar</button>
        </div>
    </div>
</div>

<div *ngIf="showCompleteModal" class="modal-overlay" (click)="onModalOverlayClick($event)">
    <div class="modal-confirm complete-modal" (click)="$event.stopPropagation()">
        <h3>Completar Tarea</h3>
        <p *ngIf="taskToComplete">
            <b>{{taskToComplete.tipo_tarea}}</b> de invernadero <b>{{taskToComplete.invernadero}}</b>
        </p>
        <div class="progress-section">
            <!-- MODO HECTÁREAS: Barra de progreso por porcentaje -->
            <div *ngIf="!isKilosMode(taskToComplete)" class="hectares-progress">
                <label>Progreso completado (debe ser 100%):</label>
                <div class="progress-container">
                    <input 
                        type="range" 
                        min="0" 
                        max="100" 
                        [(ngModel)]="progressValue"
                        class="progress-slider"
                        [class.complete]="progressValue === 100">
                    <div class="progress-display">
                        <span class="progress-text">{{progressValue}}%</span>
                        <span class="progress-requirement" [class.satisfied]="progressValue === 100">
                            {{progressValue === 100 ? '✅ Completado' : '⚠️ Debe ser 100%'}}
                        </span>
                    </div>
                    <div class="hectares-display" *ngIf="taskToComplete">
                        <span class="hectares-text">
                            {{getHectaresFromProgress()}} / {{formatDimensionTotal(taskToComplete.dimension_total)}} hectáreas
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- MODO KILOS: Input directo para kilos recogidos -->
            <div *ngIf="isKilosMode(taskToComplete)" class="kilos-progress">
                <label for="kilosRecogidos">Kilos recogidos <span class="asterisk">*</span>:</label>
                <div class="kilos-input-container">
                    <input 
                        type="number" 
                        id="kilosRecogidos"
                        [(ngModel)]="kilosRecogidosValue"
                        min="0"
                        step="0.1"
                        class="kilos-input-progress"
                        placeholder="Ingresa los kilos recogidos"
                        required>
                    <span class="kilos-unit">Kg</span>
                </div>
                <div class="kilos-info" *ngIf="taskToComplete">
                    <small>Kilos esperados: {{formatDimensionTotal(taskToComplete.dimension_total)}} kg</small>
                    <div class="kilos-progress-indicator">
                        <span class="progress-info">
                            ✅ Registro actual: {{(kilosRecogidosValue || 0)}} kg
                        </span>
                        <small><em>Nota: Las tareas en kilos no requieren alcanzar una meta específica</em></small>
                    </div>
                </div>
            </div>
            
            <!-- Campo para horas reales -->
            <div class="jornales-reales-section">
                <label for="jornalesReales">Horas realmente trabajadas <span class="asterisk">*</span>:</label>
                <input 
                    type="number" 
                    id="jornalesReales"
                    [(ngModel)]="jornalesRealesValue"
                    min="0.1"
                    step="0.1"
                    class="jornales-input"
                    placeholder="Ingresa las horas trabajadas (obligatorio)"
                    required>
                <small class="jornales-info">
                    *Estimación inicial: {{taskToComplete?.estimacion_horas || 0}} jornales
                </small>
            </div>

            <!-- Sección de asignación de trabajadores -->
            <div class="workers-section">
                <div class="workers-header">
                    <h4>Asignación de Trabajadores</h4>
                    <button 
                        type="button"
                        class="workers-btn" 
                        (click)="onOpenWorkersModal()"
                        [disabled]="jornalesRealesValue <= 0">
                        👥 Horas trabajadores
                    </button>
                </div>
                
                <div class="workers-status">
                    <p class="status-message" [class.valid]="trabajadoresValidados" [class.invalid]="!trabajadoresValidados">
                        {{getWorkersValidationMessage()}}
                    </p>
                    
                    <div *ngIf="trabajadoresAsignados.length > 0" class="workers-summary">
                        <h5>Trabajadores asignados:</h5>
                        <ul class="workers-list-summary">
                            <li *ngFor="let asignado of trabajadoresAsignados">
                                <strong>{{asignado.trabajador.nombre}}</strong> - {{asignado.horas}}h
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button 
                class="task-action-btn update-btn" 
                (click)="onUpdateProgressOnly()"
                [disabled]="isProcessing || !canProceedWithUpdate() || (!isKilosMode(taskToComplete) && (progressValue === (taskToComplete?.progreso || 0) || progressValue === 100))">
                📊 <span *ngIf="isKilosMode(taskToComplete)">{{isProcessing ? 'Registrando...' : 'Registrar kilos'}}</span><span *ngIf="!isKilosMode(taskToComplete)">{{isProcessing ? 'Actualizando...' : 'Actualizar progreso'}}</span>
            </button>
            <button 
                class="task-action-btn complete-btn" 
                (click)="onConfirmCompleteTask()"
                [disabled]="isProcessing || !canProceedWithUpdate() || (!isKilosMode(taskToComplete) && progressValue !== 100)">
                🏁 {{isProcessing ? 'Terminando...' : 'Terminar tarea'}}
            </button>
            <button class="task-action-btn" (click)="onCancelCompleteTask()" [disabled]="isProcessing">{{isProcessing ? 'Procesando...' : 'Cancelar'}}</button>
        </div>
    </div>
</div>

<section id="tasks">
    <header>
        <ng-container *ngIf="isEncargado; else superiorHeader">
            <div class="header-flex">
                <div *ngIf="!isAddingTask && !editingTask" class="filter-dropdown filter-pegado" [class.open]="showFilterMenu" tabindex="0">
                    <button class="task-action-btn filter-btn" (click)="toggleFilterMenu()" type="button">
                        <span class="icon">🔽</span> Filtrar/Ordenar
                    </button>
                    <div class="filter-menu" *ngIf="showFilterMenu">
                        <div class="filter-group">
                            <label>Filtrar por invernadero:</label>
                            <select [(ngModel)]="selectedInvernadero" (change)="applyFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let inv of invernaderos" [value]="inv">{{inv}}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filtrar por tipo:</label>
                            <select [(ngModel)]="selectedTipo" (change)="applyFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let tipo of tiposTarea" [value]="tipo">{{tipo}}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Ordenar por fecha límite:</label>
                            <select [(ngModel)]="selectedFechaOrden" (change)="applyFilters()">
                                <option value="desc">Más lejana primero</option>
                                <option value="asc">Más cercana primero</option>
                            </select>
                        </div>
                        <button class="task-action-btn" (click)="resetFilters()">Quitar filtros</button>
                    </div>
                </div>
                <div class="encargado-header-actions">
                    <h2 style="margin-left:0.5em;">Mis Tareas</h2>
                    <button class="task-action-btn urgent-task-btn" (click)="onStartUrgentTask()">
                        <span class="icon">⚡</span> Tarea Urgente
                    </button>
                </div>
            </div>
        </ng-container>
        <ng-template #superiorHeader>
            <h2>Gestión de Tareas</h2>
            <div class="header-actions">
                <div *ngIf="!isAddingTask && !editingTask" class="filter-dropdown" [class.open]="showFilterMenu" tabindex="0">
                    <button class="task-action-btn filter-btn" (click)="toggleFilterMenu()" type="button">
                        <span class="icon">🔽</span> Filtrar/Ordenar
                    </button>
                    <div class="filter-menu" *ngIf="showFilterMenu">
                        <div class="filter-group">
                            <label>Filtrar por invernadero:</label>
                            <select [(ngModel)]="selectedInvernadero" (change)="applyFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let inv of invernaderos" [value]="inv">{{inv}}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filtrar por tipo:</label>
                            <select [(ngModel)]="selectedTipo" (change)="applyFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let tipo of tiposTarea" [value]="tipo">{{tipo}}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filtrar por encargado:</label>
                            <select [(ngModel)]="selectedEncargado" (change)="applyFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let encargado of encargados" [value]="encargado">{{encargado}}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Ordenar por fecha límite:</label>
                            <select [(ngModel)]="selectedFechaOrden" (change)="applyFilters()">
                                <option value="desc">Más lejana primero</option>
                                <option value="asc">Más cercana primero</option>
                            </select>
                        </div>
                        <button class="task-action-btn" (click)="resetFilters()">Quitar filtros</button>
                    </div>
                </div>
                <menu *ngIf="!isEncargado">
                    <button (click)="onStartAddTask()">Añadir tarea</button>
                </menu>
            </div>
        </ng-template>
    </header>

    <!-- Botones de filtro por estado para ambos roles -->
    <div class="estado-filters">
        <button 
            class="estado-btn" 
            [class.active]="selectedEstado === 'sin-iniciar'"
            (click)="setEstadoFilter('sin-iniciar')">
            <span class="estado-icon">⏳</span>
            <span *ngIf="isEncargado">Pendientes</span>
            <span *ngIf="!isEncargado">Sin Iniciar</span>
        </button>
        <button 
            class="estado-btn" 
            [class.active]="selectedEstado === 'en-progreso'"
            (click)="setEstadoFilter('en-progreso')">
            <span class="estado-icon">🚀</span>
            En Progreso
        </button>
        <button 
            class="estado-btn" 
            [class.active]="selectedEstado === 'terminadas'"
            (click)="setEstadoFilter('terminadas')">
            <span class="estado-icon">✅</span>
            Terminadas
        </button>
        <button 
            class="estado-btn" 
            [class.active]="selectedEstado === 'por-validar'"
            (click)="setEstadoFilter('por-validar')">
            <span class="estado-icon">⚠️</span>
            Por Validar
        </button>
    </div>

    <ul>
        <li *ngIf="loading"><span style="color: #aaa;">Cargando tareas...</span></li>
        <li *ngIf="!loading && tasks.length === 0"><span style="color: #aaa;">No hay tareas para este usuario.</span></li>
        <li *ngFor="let task of filteredTasks; trackBy: trackById" 
            class="task-card" 
            [class.overdue-task]="isTaskOverdue(task)"
            [hidden]="loading || tasks.length === 0">
            <div class="task-card-content">
                <div class="task-card-header">
                    <strong>{{task.tipo_tarea}}</strong>
                </div>
                <div class="task-card-desc">{{task.descripcion}}</div>
                <div class="task-card-meta">
                    <span>Invernadero: <b>{{task.invernadero}}</b></span>
                    <span *ngIf="!isUrgentTask(task)">Estimación jornales: <b>{{task.estimacion_horas}}</b></span>
                    <span *ngIf="task.jornales_reales && task.jornales_reales > 0">Horas reales: <b>{{task.jornales_reales}}</b></span>
                    <!-- Eliminado mensaje de URGENTE horas trabajadas -->
                    <span [class.overdue-date]="isTaskOverdue(task)">
                        Fecha límite: <b>{{task.fecha_limite}}</b>
                        <span *ngIf="isTaskOverdue(task)" class="overdue-badge">⚠️ VENCIDA</span>
                    </span>
                    <span *ngIf="!isEncargado && task.encargado_nombre">Encargado: <b>{{task.encargado_nombre}}</b></span>
                    <span *ngIf="getTaskState(task)">
                        Estado: <b>
                            <!-- Tareas de kilos: Lógica especial -->
                            <ng-container *ngIf="isKilosMode(task)">
                                <span *ngIf="getTaskState(task) === 'No iniciado'">No iniciado</span>
                                <span *ngIf="getTaskState(task) === 'Terminada'">Terminada</span>
                                <span *ngIf="getTaskState(task) !== 'No iniciado' && getTaskState(task) !== 'Terminada'">Iniciada</span>
                            </ng-container>
                            <!-- Tareas normales (hectáreas): Mostrar progreso normal -->
                            <ng-container *ngIf="!isKilosMode(task)">
                                <span *ngIf="isNumber(getTaskState(task))" class="progress-value">
                                    {{getTaskState(task)}}%
                                    <span *ngIf="getDetailedProgress(task)" class="detailed-progress"></span>
                                </span>
                                <span *ngIf="!isNumber(getTaskState(task))">{{getTaskState(task)}}</span>
                            </ng-container>
                        </b>
                    </span>
                    <span *ngIf="task.fecha_inicio">Iniciada: <b>{{task.fecha_inicio}}</b></span>
                    <span *ngIf="task.fecha_fin">Terminada: <b>{{task.fecha_fin}}</b></span>
                    <span *ngIf="task.dimension_total">
                        <!-- Mostrar dimensión diferente según el tipo -->
                        <span *ngIf="isKilosMode(task)">Kilos esperados: <b>{{formatDimensionTotal(task.dimension_total)}} kg</b></span>
                        <span *ngIf="!isKilosMode(task)">Dimensión: <b>{{formatDimensionTotal(task.dimension_total)}} Ha</b></span>
                    </span>
                </div>
                
                <!-- Información de trabajadores para tareas urgentes -->
                <div *ngIf="isUrgentTask(task) && hasTaskWorkers(task.id)" class="urgent-workers-info">
                    <div class="workers-title">👥 Personal asignado:</div>
                    <div class="workers-list">
                        <div *ngFor="let trabajador of getTaskWorkers(task.id)" class="worker-item">
                            <span class="worker-name">{{ trabajador.nombre }}</span>
                            <span class="worker-hours">{{ trabajador.horasTotal }}h</span>
                        </div>
                    </div>
                </div>
                
                <div *ngIf="isEncargado && !isTaskCompleted(task)" class="task-actions">
                    <button *ngIf="getTaskState(task) === 'No iniciado'" 
                                    class="task-action-btn accept-btn" 
                                    (click)="onAcceptTask(task)">
                        <span class="icon">✅</span> Aceptar tarea
                    </button>
                    <button *ngIf="getTaskState(task) === 'Iniciada' || (isNumber(getTaskState(task)) && toNumber(getTaskState(task)) >= 0)" 
                                    class="task-action-btn progress-btn" 
                                    (click)="onOpenProgressModal(task)">
                        <span class="icon">📊</span> 
                        Actualizar progreso
                    </button>
                    <small *ngIf="task.fecha_actualizacion && (getTaskState(task) === 'Iniciada' || (isNumber(getTaskState(task)) && toNumber(getTaskState(task)) >= 0))" 
                           class="last-update-info">
                        {{getLastUpdateInfo(task)}}
                    </small>
                </div>
                <div *ngIf="isEncargado && isTaskCompleted(task)" class="task-completed-notice">
                    <span class="completed-text">
                        <span class="icon">🔒</span> Tarea completada - No disponible para encargados
                    </span>
                </div>
                <div *ngIf="!isEncargado && getTaskState(task) === 'Por validar'" class="task-actions">
                    <button class="task-action-btn validate-btn" (click)="onValidateUrgentTask(task)">
                        <span class="icon">✅</span> Validar Tarea
                    </button>
                    <button class="task-action-btn delete-btn" (click)="onConfirmDeleteTask(task)">
                        <span class="icon">🗑️</span> Rechazar
                    </button>
                </div>
                <div *ngIf="!isEncargado && !isTaskCompleted(task) && (task.progreso || task.proceso) !== 'Por validar'" class="task-actions">
                    <button class="task-action-btn delete-btn" (click)="onConfirmDeleteTask(task)"><span class="icon">🗑️</span> Eliminar</button>
                    <button class="task-action-btn edit-btn" (click)="onStartEditTask(task)"><span class="icon">✏️</span> Editar</button>
                </div>
                <div *ngIf="!isEncargado && isTaskCompleted(task)" class="task-completed-notice">
                    <span class="completed-text">
                        <span class="icon">🔒</span> Tarea completada - No se puede modificar
                    </span>
                </div>
            </div>
        </li>
    </ul>
</section>

<!-- Modal de asignación de trabajadores -->
<app-asignar-trabajadores
    [showModal]="showWorkersModal"
    [horasRequeridas]="jornalesRealesValue"
    [trabajadoresAsignados]="trabajadoresAsignados"
    (closeModal)="onCloseWorkersModal()"
    (saveAssignments)="onSaveWorkerAssignments($event)">
</app-asignar-trabajadores>

